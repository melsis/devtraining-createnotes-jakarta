<?xml version="1.0" encoding="UTF-8"?>
<record_update table="sp_widget">
    <sp_widget action="INSERT_OR_UPDATE">
        <client_script><![CDATA[function($scope,$rootScope, spModal, spUtil) {
	/* widget controller */
	var c = this;

	$rootScope.$on('selectNote', function(event,data) {
		c.server.get({
			action: 'getNote',
			noteID: $rootScope.noteID
		}).then(function(r) {
			c.data.title = r.data.note.title;
			c.data.note = r.data.note.note;
			c.data.noteID = r.data.note.sys_id;
		});
	});
	
	c.updateNote = function(updateType){
		c.server.get({
			action: 'updateNote',
			noteID: c.data.noteID,
			noteTitle: c.data.title,
			noteBody:c.data.note
		}).then(function(r){
			// when promise return send the event
			$rootScope.$emit('updatedNote',r.data);
		});
		
	}//
	
	c.confirmDelete = function(){
		spModal.confirm("Are you sure you want to delete?").then(function(confirmed){
			if (confirmed){
				c.deleteNote();
			}
		});
	}
	
	c.deleteNote = function(){
		// we ask server to delete the nore
		// wait for a response promise
		// then emit/pubish the event so List widget can be updated
		
		c.server.get({
			action: 'deleteNote',
			noteID: c.data.noteID
		}).then(function(r){
			// inform the user
			spUtil.addTrivialMessage("Note:" + c.data.title + " was deleted");
			// remove data on client
			c.data.title= '';
			c.data.note= '';
			$rootScope.$emit('deleteNote', c.data.noteID);
			c.data.noteID = '';
			
			
		});
	}
	
}]]></client_script>
        <controller_as>c</controller_as>
        <css/>
        <data_table>sp_instance</data_table>
        <demo_data/>
        <description/>
        <docs/>
        <field_list/>
        <has_preview>true</has_preview>
        <id>notes_body</id>
        <internal>false</internal>
        <link/>
        <name>Notes Body</name>
        <option_schema>[{"hint":"Create a title for your widget","name":"title","default_value":"Note Body","label":"Title","type":"string"}]</option_schema>
        <public>false</public>
        <roles/>
        <script><![CDATA[(function() {
	/* populate the 'data' object */

	if (input && input.noteID) {
		var noteGR = new GlideRecord('x_snc_createnotes_note');
		
		
		if (noteGR.get(input.noteID)) {
			if (input.action == 'getNote') {
				data.note = {};
				$sp.getRecordValues(data.note, noteGR, "title, note, sys_id");
			}
		else if (input.action == 'updateNote'){
				noteGR.title = input.noteTitle;
				noteGR.note = input.noteBody;
				noteGR.update();
			  
			  data.title = noteGR.getValue('title');
			  data.note = noteGR.getValue('note').slice(0,30);
			}
		else if (input.action == 'deleteNote'){
			noteGR.deleteRecord();
		}
		}

	}
})();]]></script>
        <servicenow>false</servicenow>
        <sys_class_name>sp_widget</sys_class_name>
        <sys_created_by>admin</sys_created_by>
        <sys_created_on>2017-12-02 12:45:27</sys_created_on>
        <sys_id>03b85069db320300b08c7befbf9619ea</sys_id>
        <sys_mod_count>43</sys_mod_count>
        <sys_name>Notes Body</sys_name>
        <sys_package display_value="CreateNotes" source="x_snc_createnotes">df5fd9a5090232007f44e1046c8ff69f</sys_package>
        <sys_policy/>
        <sys_scope display_value="CreateNotes">df5fd9a5090232007f44e1046c8ff69f</sys_scope>
        <sys_update_name>sp_widget_03b85069db320300b08c7befbf9619ea</sys_update_name>
        <sys_updated_by>admin</sys_updated_by>
        <sys_updated_on>2017-12-06 18:05:29</sys_updated_on>
        <template><![CDATA[<div class="panel panel-default" ng-controller="c" >
  <div class="panel-heading clearfix">
    <div class="row">
      <h4>
        {{::c.options.title}}
      </h4>
      <div class="col-md-11">
        <input class="form-control" id="note-title" ng-change="c.updateNote('title')" ng-show="c.data.noteID" ng-model="c.data.title" />
      </div>
      <delete-button-confirm></delete-button-confirm>
    </div>
  </div>
  <div class="panel-body">
    <textarea class="form-control" id="note-body" ng-change="c.updateNote('body')" ng-show="c.data.noteID" ng-model="c.data.note" ></textarea>
  </div>
</div>]]></template>
    </sp_widget>
</record_update>
